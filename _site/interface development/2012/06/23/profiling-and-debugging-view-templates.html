
<!doctype HTML>
<html>
<head>
<title>Tech Blog - Profiling and debugging view templates</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" media="all" href="http://finncdn.no/bb/latest/css/so/so.css">
<!--[if IE 9 ]>
<link rel="stylesheet" type="text/css" media="screen,projection,handheld" href="http://finncdn.no/bb/latest/css/so/styles/so/ie9.css" />
<![endif]-->
<!--[if IE 8 ]>
<link rel="stylesheet" type="text/css" media="screen,projection,handheld" href="http://finncdn.no/bb/latest/css/so/styles/so/ie8.css" />
<![endif]-->
<!--[if lte IE 8]>
<link rel="stylesheet" type="text/css" media="screen,projection,handheld,print" href="http://finncdn.no/bb/latest/css/so/styles/so/ie.css" />
<![endif]-->
<link media="print" href="http://finncdn.no/bb/latest/css/so/styles/so/print.css">
<style>
body {
     height: 100%;
     margin: 0;
     padding: 0;
}
body > .media {
  margin-top: 0;
}
.xxl {
  padding-top: 70px;
}
.deco {
  background: url("http://cache.finn.no/img/decoration/decoration_frontpage.png") no-repeat center top;
  height: 57px;
  top: -24px;
  width: 840px;
  left: 94px;
  position: absolute;
}
.nerddeco {
  border-top: 2px solid black;
  background: url("http://hjemmehos.finn.no/no/webfolk_+_entusiaster/filestore/dev/GFX/menu_gadgets.png") no-repeat;
  height: 200px;
}
</style>
</head>
<body>

 <div class="media">
      <img class="img" src="http://finn-no.github.io/img/tech_logo.png">
      <p class=" bd h1 xxl"><a href="/">Tech Blog</a></p>
 </div>
 <div class="relative hidelt768">
  <div class="deco"></div>
 </div>
<div class="line pal" >
  <div class="unit r-size2of3">
    <div class="mod shadow">
      <div class="inner">
        <div class="bd">

          <h1>Profiling and debugging view templates</h1>
<p class="meta">23 Jun 2012 by  in </p>

<div class="post">
<p>Ever needed to profile the tree of JSPs rendered server-side?
Most companies do and I've seen elaborate and rather convoluted ways to do so.</p>

<p>With Tiles-3 you can use the <code>PublisherRenderer</code> to profile and debug not just the tree of JSPs but the full tree of all and any view templates rendered whether they be JSP, velocity, freemarker, or mustache.</p>

<p>At FINN all web pages print such a tree at the bottom of the page. This helps us see what templates were involved in the rendering of that page, and which templates are slow to render.</p>

<p><a href="http://tech.finn.no/2012/06/23/profiling-and-debugging-view-templates/screenshot-tiles-publisherrenderer-tree/"><img src="http://tech.finn.no/wp-content/uploads/2012/06/Screenshot-tiles-publisherrenderer-tree.png" alt="" /></a>
We also embed into the html source wrapping comments like</p>

<pre><code>...template output...
</code></pre>

<h2>The code please</h2>

<p>To do this register and then attach your own listener to the <code>PublisherRenderer</code>. For example in your <code>TilesContainerFactory</code> (the class you extend to setup and configure Tiles) add to the methd createTemplateAttributeRenderer something like:</p>

<pre><code>    @Override
    protected Renderer createTemplateAttributeRenderer(BasicRendererFactory rendererFactory, ApplicationContext applicationContext, TilesContainer container, AttributeEvaluatorFactory attributeEvaluatorFactory) {

        Renderer renderer = super.createTemplateAttributeRenderer(rendererFactory, applicationContext, container, attributeEvaluatorFactory);
        PublisherRenderer publisherRenderer = new PublisherRenderer(renderer);
        publisherRenderer.addListener(new MyListener());
        return publisherRenderer;
    }
</code></pre>

<p>Then implement your own listener, this implementation does just the wrapping comments with profiling information...</p>

<pre><code>class MyListener implements PublisherRenderer.RendererListener {

    @Override
    public void start(String template, Request request) throws IOException {
        boolean first = null == request.getContext("request").get("started");
        if (!first) {
            // first check avoids writing before a template's doctype tag
            request.getPrintWriter().println("\n");
            startStopWatch(request);
        } else {
            request.getContext("request").put("started", Boolean.TRUE);
        }
    }

    @Override
    public void end(String template, Request request) throws IOException {
        Long time = stopStopWatch(request);
        if(null != time){
            request.getPrintWriter().println("\n");
        }
    }

    private void startStopWatch(Request request){
        Deque&lt;stopwatch&gt; stack = request.getContext("request").get("stack");
        if (null == stack) {
            stack = new ArrayDeque&lt;stopwatch&gt;();
            request.getContext("request").put("stack", stack);
        }
        StopWatch watch = new StopWatch();
        stack.push(watch);
        watch.start();
    }

    private Long stopStopWatch(Request request){
        Deque&lt;stopwatch&gt; stack = request.getContext("request").get("stack");
        return 0 &lt; stack.size() ? stack.pop().getTime() : null;
    }
</code></pre>

<p>It's quick to see the possibilities for simple and complex profiling open up here as well as being agnostic to the language of each particular template used. Learn more about <a href="http://tiles.apache.org/">Tiles-3 here</a>.</p>

</div>



        </div>
      </div>
    </div>
  </div>
  <div class="unit r-size1of3">
    <div class="mod shadow mbn">
      <div class="inner">
        <div class="bd">

          <h2>Whatâ€™s this?</h2>
          <p>This is a blog run by the people creating the service <a href="http://www.finn.no">FINN.no</a>. Our purpose with this blog is to provide an insight into how we build things and to share our experiences with anyone who is interested in learning.
          </p>

          <h2>Categories</h2>
          <ul class="bullets phl">
            
              <li><a href="/categories/interface development.html">interface development</a></li>
            
              <li><a href="/categories/systems development.html">systems development</a></li>
            
              <li><a href="/categories/behind the scenes.html">behind the scenes</a></li>
            
              <li><a href="/categories/methodology.html">methodology</a></li>
            
          </ul>

          <h2>Blogroll</h2>
          <ul>
            <li><a href="http://labs.finn.no" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://labs.finn.no']);">FINN Labs</a></li>
            <li><a href="http://finn.no" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://finn.no']);">FINN.no</a></li>
            <li><a href="http://github.com/finn-no" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://github.com/finn-no']);">Our GitHub projects</a></li>
          </ul>
          <a class="phl" href="https://developer.mozilla.org/en/JavaScript" title="MDN JavaScript Home"><img src="http://static.jsconf.us/promotejsh.gif" height="150" width="180" alt="MDN JavaScript Home"></a>

        </div>
      </div>
    </div>
    <div class="mod nerddeco"></div>
  </div>
</div>
<div class="footer pal bg-contrast contrast">
  <a href="http://twitter.com/finn_tech">Finn Technology on Twitter</a> |
  <a href="http://tech.finn.no">Our developer blog</a> |
  <a href="http://hjemmehos.finn.no/no/jobbe_her+/">Come work with us!</a> |
  <a href="http://finn.no">FINN.no</a>
</div>
</div>
</body>
</html>