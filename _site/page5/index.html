
<!doctype HTML>
<html>
<head>
<title>Tech Blog - developers at FINN blogging about technology</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" media="all" href="http://finncdn.no/bb/latest/css/so/so.css">
<!--[if IE 9 ]>
<link rel="stylesheet" type="text/css" media="screen,projection,handheld" href="http://finncdn.no/bb/latest/css/so/styles/so/ie9.css" />
<![endif]-->
<!--[if IE 8 ]>
<link rel="stylesheet" type="text/css" media="screen,projection,handheld" href="http://finncdn.no/bb/latest/css/so/styles/so/ie8.css" />
<![endif]-->
<!--[if lte IE 8]>
<link rel="stylesheet" type="text/css" media="screen,projection,handheld,print" href="http://finncdn.no/bb/latest/css/so/styles/so/ie.css" />
<![endif]-->
<link media="print" href="http://finncdn.no/bb/latest/css/so/styles/so/print.css">
<style>
body {
     height: 100%;
     margin: 0;
     padding: 0;
}
body > .media {
  margin-top: 0;
}
.xxl {
  padding-top: 70px;
}
.deco {
  background: url("http://cache.finn.no/img/decoration/decoration_frontpage.png") no-repeat center top;
  height: 57px;
  top: -24px;
  width: 840px;
  left: 94px;
  position: absolute;
}
.nerddeco {
  border-top: 2px solid black;
  background: url("http://hjemmehos.finn.no/no/webfolk_+_entusiaster/filestore/dev/GFX/menu_gadgets.png") no-repeat;
  height: 200px;
}
</style>
</head>
<body>

 <div class="media">
      <img class="img" src="http://finn-no.github.io/img/tech_logo.png">
      <p class=" bd h1 xxl"><a href="/">Tech Blog</a></p>
 </div>
 <div class="relative hidelt768">
  <div class="deco"></div>
 </div>
<div class="line pal" >
  <div class="unit r-size2of3">
    <div class="mod shadow">
      <div class="inner">
        <div class="bd">

          
  <h1><a href="interface%20development/2011/06/27/graded-browser-support-version-1-1.html">Graded browser support version 1.1</a></h1>
  url=/interface%20development/2011/06/27/graded-browser-support-version-1-1.html
  <p class="author">
    <span class="date">2011-06-27 13:41:23 UTC</span>
  </p>
  <div class="content">
    <p>We have reworked our <a href="http://labs.finn.no/nettlesermatrisen/">graded browser support matrix</a> which was <a href="/2011/01/07/graded-browser-support-at-finn-no/">released last year</a>. Following <a href="http://lawsofsimplicity.com/">the Laws of Simplicity</a> we reduced the complexity in order to make it easier for everyone at our company to understand. We cut a lot of the version number into targeting latest for browsers which are frequently updated. There is also a <a href="http://labs.finn.no/nettlesermatrisen/phone.html">support matrix for mobile phones</a> which is targeting our new mobile web service <a href="http://m.finn.no">m.finn.no</a>.</p>

<p>In addition to updating the versions we have also made the decision to include tablets in the support matrix for our desktop verison of our service. This is because we are currently not looking at creating specialized versions for tablets and our service works just fine on the tablets currently hitting our site. Currently almost all of our trafic is coming from iPad's, therefor Andoid powered devices are not supported.</p>

  </div>
  <p>2011-06-27 13:41:23 UTC by espen in interface development</p>
  <hr>

  <h1><a href="behind%20the%20scenes/2011/06/24/hosting-our-first-ever-hackaton.html">Hosting our first ever hackaton</a></h1>
  url=/behind%20the%20scenes/2011/06/24/hosting-our-first-ever-hackaton.html
  <p class="author">
    <span class="date">2011-06-24 07:09:41 UTC</span>
  </p>
  <div class="content">
    <p>Inspired by seeing how much fun and how much innovation is going on at hackatons all over the world we finally go round to hosting one ourselves. The first ever hackaton event at FINN.no was hosted on the 22-23. of june. At FINN.no we are accustomed to working in cross functional teams, so it was only natural that we invited the entire company to attend our hackaton. In order not to scare people with a non-technical background we had to change the name, so we created what we call <a href="http://finnovasjonsdagen.org/blog/">FINNovasjonsdagen</a> (which translates into FINNovationday). We decided to keep this one open for only employees since this was our first shot at this.</p>

<h2>What happened?</h2>

<p>In total there where 43 attendants spread out across 13 teams, where about half of the attendants had the opportunity to stay the entire time. After the 24 hours we invited the entire company to come and vote on which team had produced the coolest thing.</p>

<p>Check out this time laps video which was shot with a web cam:</p>

<p>The winners of the hackaton was awarded the price of 25 thousand NOKs and bragging rights until the next event. Team Meh created a global search for all of FINN.no fully integrated and almost ready to be rolled out into production. This has been something our users and employees have been supporting for years and to see that a team of three was able to crank it out in 24 hours was quite an accomplishment.</p>

<p><a href="http://finnovasjonsdagen.org/blog/">Check out the blog</a> from the event for more pictures and more details about all the things created (<a href="http://translate.google.com/translate?js=n&amp;prev=_t&amp;hl=en&amp;ie=UTF-8&amp;layout=2&amp;eotf=1&amp;sl=no&amp;tl=en&amp;u=http%3A%2F%2Fwww.finnovasjonsdagen.org%2Fblog%2F&amp;act=url">English translation of the blog</a>).</p>

  </div>
  <p>2011-06-24 07:09:41 UTC by espen in behind the scenes</p>
  <hr>

  <h1><a href="systems%20development/2011/05/12/dependency-injection-with-constructors.html">Dependency Injection with constructors?</a></h1>
  url=/systems%20development/2011/05/12/dependency-injection-with-constructors.html
  <p class="author">
    <span class="date">2011-05-12 23:01:00 UTC</span>
  </p>
  <div class="content">
    <p><img src="/wp-content/uploads/2011/05/neo-300x300.jpg" alt="Pic of Neo/The Matrix" /></p>

<p><strong><em>The debate whether to use <br/>
constructors, setters, fields, or interfaces <br/>
for <a href="http://martinfowler.com/articles/injection.html">dependency injection</a> is often heated and opinionated. <br/>
Should you have a preference?</em></strong></p>

<h2>The argument for Constructor Injection</h2>

<p>We had a consultant working with us reminding us to take a preference towards Constructor injection. Indeed we had a large code base using predominantly setter injection because in the past that is what the Spring community recommended.</p>

<p>The arguments for constructor injection goes like:</p>

<ul>
<li><p>Dependencies are <em>declared</em> public, providing clarity in the wiring of <strong>Dependency Inversion</strong>,</p></li>
<li><p><strong>Safe construction</strong>, what must be initialised must be called,</p></li>
<li><p><strong>Immutability</strong>, fields can be declared final, and</p></li>
<li><p>Clear <strong>indication of complexity</strong> through numbers of constructor parameters.</p></li>
</ul>


<p>And that Setter injection can be used when needed for cyclic dependencies, optional and re-assignable dependencies, to support multiple/complicated variations of construction, or to free up the constructor for polymorphism purposes.</p>

<p>Being a big fan of Inversion of Control but not overly of Dependency Injection frameworks something smelt wrong to me. Yet solely within the debate of constructor versus setter injection i don't disagree that constructor injection has the advantage. Having been using Spring's dependency injection through annotation a little recently and building a favouritism towards field injection I was happy to get the chance to ponder it over, to learn and to be taught new things. What was it i was missing? Is there a bigger picture?</p>

<h2>API vs Implementation</h2>

<p>If there is a bigger picture it has to be around the Dependency Inversion argument since this is known to be potentially complex. The point here of using constructor injection is that <em>1)</em> through a public declaration and injection of dependencies we build an explicit graph showing the dependency inversion throughout the application, and <em>2)</em> even if the application is wired magically by a framework such injection must still be done in the same way without the framework (eg when writing tests).  The latter <em>(2)</em> is interesting in that the requirement on "dependency injection" is too also inverted, that the framework providing dependency injection is removed from the architectural design and becomes solely a implementation detail. But it is the graph in <em>(1)</em> that becomes an important facet in the following analysis.</p>

<p>With this dependency graph in mind what does happen when we bring into the picture a desire to distinguish between API and implementation design...</p>

<p>The DI graph being requested to be clarified by using constructor injection will fall into one of two categories:
<strong>→</strong> 'implementation-specific', an interface defines the public API and the DI is held private by the constructor in the implementation class,
<strong>→</strong> 'API-specific' when the class has no interface. Here everything public is a fully exposed api. There is no implementation-protected visibility here for injectable constructors.</p>

<p> By introducing the constraint of only ever using constructor based injection: in the pursuit of a clarified dependency graph; you remove or make more difficult the ability to publicly distinguish between API and Implementation design.</p>

<p> This distinction between API and implementation is important in being able to create the simple API. The previous blog "<a href="http://tech.finn.no/2011/01/19/using-the-constretto-configuration-factory/">using the constretto configuration factory</a>" is a co-incidental example of this. I think the work in Constretto has an excellent implementation design to it, but this particular issue raised frustrations that the API was not as simple as it could have been. Indeed: to obtain the "simplest api"; Constretto (intentionally or not) promotes the use of Spring's injection, a loose coupling that can be compared to reflection. It may be that our usage of Constretto's API, where we wanted to isolate groups of properties, was not what the author originally intended but this only re-enforces the need for designing the simplest possible API.</p>

<p>Therefore it is important to sometimes have all dependency injection completely hidden in the implementation. A clean elegant API must take precedence over a clean elegant implementation. And to achieve this one must first make that distinction between API and Implementation design.</p>

<p>Taking this further we can introduce the distinction between <a href="http://wiki.apidesign.org/index.php?title=APIvsSPI&amp;useskin=monobook">API and SPI</a>. Here a good practice is to stick to using final classes for API and interfaces for SPI. By the same argument as above SPI can't use constructor injection because they don't have constructors.</p>

<h2>Inversion-of-Control vs Dependency-Injection</h2>

<p>What about the difference between IoC and DI. They are overlapping concepts: the subtlety between the “the contexts” and “the dependencies” rarely emphasised enough. (Java EE 6 has tried to address the distinction between contexts and dependencies at the implementation level with the <a href="http://www.oracle.com/technetwork/articles/java/cdi-javaee-bien-225152.html">CDI spec</a>.) The difference between the two, nuanced as it may be, can help illustrate that the DI graph in any application deserves attention in multiple dimensions.</p>

<p><img src="/wp-content/uploads/2011/05/request-stack.png" alt="" /></p>

<p>Drawing an application's architecture up as a graph where the vertical axis represents the request stack: that which is typically categorised into architectural layers view, control, and model/services; and the horizontal axis representing the broadness of each architectural layer, then it can be demonstrated that:
<strong>→</strong> IoC generally forms the passing and layering of contexts downwards.</p>

<p><strong>→</strong> The <em>api-specific</em> DI is fulfilling the layer of such contexts, and these contexts can be dependencies directly or helper classes holding such dependencies. Such dependencies must therefore be initially defined high up in the stack.</p>

<p><strong>→</strong> The DI that is <em>implementation-specific</em> is at most only visible inside each architectural layer and is the DI that is represented horizontally on the graph. Possibly still within the definition of IoC it can also be considered a "wiring of collaborating components". The need for clarity in the dependency graph isn't as critical and so applications here often tend towards Service Locators, Factories, and Injectable Singletons. On the other hand many of the existing Service Locator implementations have been poor enough to push people towards (and possibly it was an instigator for the initial implementations of) dependency injection.</p>

<p><strong>→</strong> Constructor injection works easily horizontally, especially when instantiation of objects is under one's ability, but has potential hurdles when working vertically down through the graph. Sticking to constructor injection horizontally can also greatly help when the wiring of an application is difficult, by ensuring at the construction of each object dependency injection has been successful. Missing setter, field, interface injection and Service Locators may not report an error until actually used in runtime.</p>

<p> A simple illustration of difficulty with vertical constructor injection is looking at these helper contexts and how they may be layering contexts through delegation rather than repetitive instantiation, a pattern more applicable for an application with a deep narrow graph. This exemplifies a pattern that has often relied on proxy classes.</p>

<p>Another illustration is when having to instantiate the initial context at the very top of the request/application stack it involves instantiating all the implementation of dependencies used in contexts down through the stack, this is when dependency inversion explodes - the case where the IoC becomes up-front and explicit, and the encapsulation of implementation is lost through an unnecessary leak of abstractions. A problem paralleling to this is trying to apply checked exceptions up through the request stack: one answer is that we need different checked exceptions per architectural layer (another answer is <a href="http://www.cs.kuleuven.be/publicaties/rapporten/cw/CW544.pdf">anchored exceptions</a>). With dependencies we would eventuate with requiring different dependency types per architectural layer and this could lead to dependencies types from inner domains needing to be declared from the outer domains. Here we can instead declare <em>resource loaders</em> in the initial context and then letting each architectural layer build from scratch its own context with dependencies constructed from configuration. But this comes the full circle in coming back to a design similar to a <em>service locator</em>. Something similar has happened with annotations in that by bringing Convention over Configuration to DI what was once loose wiring with xml has become the magic of the convention and begins too to resemble the <em>service locator</em> or <em>naming lookups</em>.</p>

<p><img src="/wp-content/uploads/2011/05/rabbits-matrix-150x150.jpg" alt="follow the white rabbit/The Matrix" /></p>

<p>For a legacy application this likely becomes all too much: the declaring of all dependencies required throughout all these contexts; and so relying on a little louse-coupling-magic (be it reflection or spring injection) is our answer out. Indeed this seems to be one of the reasons spring dependency injection was introduced into FINN.
<em>And so we've become less worried about the type of injection used...</em></p>

<h2>Broad vs Deep Applications</h2>

<p> <a href="http://www.finn.no">FINN.no</a> is generally a broad application with a shallow contextual stack. Here is the traditional view-control-model design and the services inside the model layer typically interact directly with the data stores and maybe interact with one or two peer services.</p>

<p> Focusing on the interfaces to the services we see there is a huge amount of public api available to the controller layer and very little in defined contexts except a few parameters, or maybe the whole parameter map, and the current user object. There is therefore very little inversion of control in our contexts, it is often just parameterisation. (Why we often use interfaces to define service APIs is interesting since we usually have no intention for client code to be supplying their own implementations, it is definitely not SPIs that are being published. Such interfaces are used as a poor-man's simplification of the API declaration of public methods within the final classes. Albeit these interfaces do make it easy to make stubs and mocks for tests.)</p>

<p> In this design the implementation details of service-layer dependencies is rarely passed down through contexts but rather hard baked into the application. And in a product like FINN it probably always will be hard baked in. Hard baked here doesn't mean it can't be changed or mocked for testing, but that it is not a dynamic component, it is not contextual, and so does not belong in the architectural design of the application.</p>

<p>In such a broad architectural layer i can see two problems in trying to obtain a perfect DI graph:</p>

<p><strong>→</strong> cyclic dependencies: bad but forgiven when existing as peers within a group. In this case constructor injection fails. We can define one as the lesser or auxiliary service and fall-back to the setter/field injection just for it, but if they are real equal peers this could be a bullet-in-the-foot approach and using field injection for both with documentation might be the better approach.</p>

<p><strong>→</strong> central dependencies: these are the "core" dependencies used throughout the bulk of the services, the database connection, resource loaders, etc. If we enforce these to be injected via constructors then we in turn are enforcing a global-store of them. Such a global store would typically be implemented as a factory or singleton. Then what is the point of injection? Worse yet is that this could encourage us to start passing the spring application context around through all our services. A <em>service locator</em> may better serve our purpose...</p>

<p>Hopefully by now you've guessed that we really should be more interested in modularisation of the code. Breaking up this very broad services layer into appropriate groups is an easier and more productive first step to take. And during this task we have found discovering and visualising the DI graph is not the problem. Untangling it is. Constructor injection can be used to prevent these tangles, but so can tools like maven reporting and sonar. This shows the the DI graph is actually more easily visualised through the class's import statements than through constructor parameters.</p>

<p>With modularisation we can minimise contexts, isolate dependency chains, publish contextual inversion of control into APIs, declare interface-injection for SPIs, and move dependency injection into wired constructors.</p>

<p><img src="/wp-content/uploads/2011/05/request-stack-2.png" alt="" /></p>

<h2>Back to Constructor injection</h2>

<p>So it's true that constructor injection goes beyond just DI in being able to provide some IoC. But it alone can not satisfy Inversion of Control in any application unless you are willing to overlook API and SPI design. DI is not a subset or union of IoC: it has uses horizontally and in loose-coupling configuration; and IoC is not a subset or union of DI: to insinuate such would mean IoC can only be implemented using spring beans leading to an application of only spring beans and singletons. In the latter case IoC will often become forgotten outside the application's realm of DI.</p>

<p>Constructor injection is especially valid when it's desired for code to be used via both spring-injection and manual injection, and it does make test code more natural java code. But imagine manually injecting every spring bean in a oversized legacy broad-stack application using constructor injection without the spring framework - is this really a possibility, let's be serious? What you would likely end up with is one massive factory with initialisation code constructing all services instead of the spring xml, and looking up using this factory every request. What's the point here? This isn't where IoC is supposed to take us.</p>

<p>If code is being moved towards a distributed and modular architecture you should pay be aware on how it clashes with the DI fan club.</p>

<p>If code is in development and you are uncertain if the dependency should be obtained through a service locator or declared public giving dependency inversion, and in the spirit of lean think it smart to not yet make the decision, then using field injection can be the practical solution.</p>

<p>And just maybe you are not looking to push the Dependency Inversion out into the API and because you think of Spring's ApplicationContext (or BeanFactory) as your application's Service Locator, you use field injection as a method to automate service locator lookups.</p>

<p>For the majority of developers for the majority of the time you will be writing new code, not caring about dependency injection trashing inversion of control, wanting lots of easy to write tests, and not be worrying about API design so it's ok to have a healthy preference towards constructor injection...</p>

<p><img src="/wp-content/uploads/2011/05/Morpheus-Red-or-Blue-Pill-the-matrix-430x370-300x258.jpg" alt="Pic of Morpheus/The Matrix" /></p>

<p><em>Keep questioning everything...</em>
...by remaining focused on what is required from the code at hand we can be pragmatic in a world full of rules and recommendations. This isn't about laziness or permitting poor code, but about being the idealist: the person that knows the middle way between the pragmatist and ideologue. By knowing: when what can, and for how long, be dropped; we can incrementally evolve complex code towards a modular design in a sensible, sustainable, and practical way.
In turn this means the programmer gets the chance to catch breath and remember <a href="/putting-a-face-on-quality/">paramount to their work is the people</a>: those that will develop against the design and those end-users of the product.</p>

<p><strong>References:</strong></p>

<ul>
<li><p>Martin Fowler gives a great introduction into all this at <a href="http://martinfowler.com/articles/injection.html">martinfowler.com/articles/injection.html</a>.</p></li>
<li><p>Taking taking this further Jaroslav Tulach presents an interesting view on Dependency Injection in relations to API design at <a href="http://wiki.apidesign.org/index.php?title=Dependency_Injection&amp;useskin=monobook">wiki.apidesign.org/index.php?title=Dependency_Injection</a></p></li>
<li><p>Another read that investigates IoC : <a href="http://shaun.boyblack.co.za/blog/2009/05/01/constructor-injection-vs-setter-injection/">Constructor Injection vs Setter Injection - Shaun Smith</a></p></li>
<li><p>What's the difference between <a href="http://neelzone.wordpress.com/2007/04/04/injection-and-inversion/">Dependency Injection and Inversion of Control</a></p></li>
</ul>


<p><strong>Credits:</strong>
A large and healthy dose of credit must go to Kaare Nilsen for being a sparring partner in the discussion that lead up to this article.</p>

  </div>
  <p>2011-05-12 23:01:00 UTC by mick in systems development</p>
  <hr>

  <h1><a href="behind%20the%20scenes/2011/05/09/putting-a-face-on-quality.html">Putting a face on quality</a></h1>
  url=/behind%20the%20scenes/2011/05/09/putting-a-face-on-quality.html
  <p class="author">
    <span class="date">2011-05-09 12:44:05 UTC</span>
  </p>
  <div class="content">
    <p>[caption id="attachment_771" align="aligncenter" width="600" caption="Photo by <a href="http://www.flickr.com/photos/dolarz">dolarz</a>"]<a href="http://tech.finn.no/wp-content/uploads/2011/05/flickrface.jpg"><img src="http://tech.finn.no/wp-content/uploads/2011/05/flickrface-600x399.jpg" alt="http://www.flickr.com/photos/dolarz/2333292651/" /></a>[/caption]</p>

<p>The topic of ensuring quality in the services we provide is a much debated topic in our industry [<a href="http://gojko.net/2011/04/27/visualising-quality-initial-ideas">1</a>]. It tends to focus upon things such as testing and how to best automate it to try and reach a state of zero defects. These initiatives are great and we should all pursue them in our daily work. These debates tend to be very focused upon the technical side and how to prevent the intrusion of defects in our build cycle. A result of the technical focus is that you become abstracted from the real issues at hand and it becomes yet another ideological debate (or even worse yet another pissing contest between believers and non-believers).</p>

<p>At <a href="http://www.finn.no">FINN.no</a> we try to always view things from an end-user perspective and technical quality is no different. So what does technical quality mean for our end users and do they really care?</p>

<h2>Making dreams come true</h2>

<p>A service such as <a href="http://www.finn.no">FINN.no</a> is much more than just a site where you view classified ads. It is a service where everyday people make some of their dreams come true. They buy the house they have been dreaming of in order to start a family. It is a place where you buy things to keep your kids safe and comfortable. So in order to answer the previous question, do they care about quality? Naturally. Down time on a Sunday at <a href="http://www.finn.no">FINN.no</a> prevents people from buying the house, the car or the boat of their dreams.</p>

<p>You get the picture right? Quality of service means that we deliver on our promisse of being a marketplace you can rely on to make some of your dreams come true. Behind the discussions about unit-test coverage there is a family not getting their house, car or boat if you mess things up. When we debate whether to write tests up-front or do waterfall planning there is someone out there not getting their car sold. We get so caught up in technology some times that we actually think that it matters. In order to try and get more in touch with how our quality affects our users we realized we had to do something. When growing from a small company to a larger company you often end up lossing track of these things and we needed to correct this.</p>

<h2>Continuous improvements a.k.a. Lean</h2>

<p>At <a href="http://www.finn.no">FINN.no</a> we have some people work solely with teaching us <a href="http://en.wikipedia.org/wiki/Continuous_improvement_process">continuous improvement</a>. They try to help every team or department to learn the <a href="http://en.wikipedia.org/wiki/Lean_software_development">Lean</a> way of working and resolving issues. By spreading their knowledge across the company they start a lot of cross-team-department-initiatives which would not happen without them.</p>

<p>Bulding quality into your product is one of the essential things towards creating an amazing user experience, but the problem is how do you do this on a regular basis? There are numerous tools available for all kinds of testing and quality analysis of code and things like that. These tools are all good and you should use them. However, they all fail to bring you the one insight which is the most valueable yo your business: what does your users actually think about what you do.</p>

<p>Our customer service and architectural teams have both been working to try and establish a way of working which ensure continuous improvement in what we do. This has resulted in an initiative to try and visualize how our level of quality effects our users and customers.</p>

<h2>FINNback or Tweet Board</h2>

<p>One easy way of putting a face on quality was to utilize the <a href="http://dev.twitter.com/pages/streaming_api">Twitter Streaming API</a> which enables us to see what people think about our service. Thanks to the <a href="http://dev.twitter.com/">brilliant engineers at Twitter</a> this was easily accomplished in just a few hours and we had a <a href="http://nodejs.org">node.js</a> application which displayed tweets about us on monitors/TVs in our cantina and in our reception. Thanks to the awesomeness of the <a href="http://dev.twitter.com/pages/streaming_api">Twitter Streaming API</a> we are able to pull both the profile picture, the profile background image and the number of followers into our application in order to give a more human feel to the tweets coming in. This was critical as it makes the tweets real as they come from real live people who we effect with our work. In the sample screenshot of the <em>FINNback</em> application  we get a confirmation of something we are painfully aware of, <a href="http://twitter.com/#!/AnetteBastnes/status/65843803675820032">we should have an app</a>.
<a href="http://tech.finn.no/wp-content/uploads/2011/05/FINNb%C3%A6kk-brettet.jpg"><img src="http://tech.finn.no/wp-content/uploads/2011/05/FINNb%C3%A6kk-brettet-600x333.jpg" alt="" /></a></p>

<p>Doing this Twitter feed visualization is just a first step and we are working hard towards creating more real-time feedback visualization in order to make sure every one of our employees knows exactly how our users feel about what we do. We are confident that this is a great way of getting focus on technical quality and to make sure we work even harder to provide a service which makes our users dreams come true.</p>

  </div>
  <p>2011-05-09 12:44:05 UTC by espen in behind the scenes</p>
  <hr>

  <h1><a href="interface%20development/systems%20development/2011/04/08/xss-protection-whos-responsibility.html">XSS protection: who's responsibility?</a></h1>
  url=/interface%20development/systems%20development/2011/04/08/xss-protection-whos-responsibility.html
  <p class="author">
    <span class="date">2011-04-08 07:09:39 UTC</span>
  </p>
  <div class="content">
    <p>In a multi-tier application who can be responsible for XSS protection?
Must security belong to a dedicated team...or can it be a shared responsibility?
Today <strong><a href="http://en.wikipedia.org/wiki/Cross-site_scripting">XSS protection</a></strong> is typically tackled by front end developers.
Let's challenge the status quo.</p>

<h2>New Applications vs Legacy Applications</h2>

<p>For protection against <em>Stored XSS</em> many applications have the luxury of ensuring any text input from the user, or from a CMS system, is made clean and safe before being written to database. Given a clean database the only XSS protection required is around request values, for example values from url parameters, cookies, and form data.</p>

<p><img src="/wp-content/uploads/2011/04/rack.jpg" alt="Image by The Planet via Flickr -- http://www.flickr.com/photos/26388913@N05/4879419700" /></p>

<p>But some applications, especially legacy applications, are in a different boat. Databases typically have lots of existing data in many different formats and tables so it's often no longer feasible to focus on protecting data on its way into the system. In this situation it is the front end developers that pay the price for the poor quality of backend data and are are left to protect everything. This often results in a napalm-the-whole-forest style of xss protection where every single variable written out in the front end templates goes through some equivalent of</p>

<pre><code>            &lt;c:out value="${someText}"/&gt; 
</code></pre>

<p>This makes sense but...   if you don't have control is your only option to be so paranoid?</p>

<h2>A Messed up World</h2>

<p>To illustrate the problem let's create a simple example by defining the following service</p>

<pre><code>  interface AdvertisementService{
    Advertisement getAdvertisement(long id);
  }

  interface Advertisement{
    /** returns plain text title */
    String getTitle();
    /** return description, which may contain html if isHtmlEnabled() returns true */
    String getDescription();
    /** indicates the description is html */
    boolean isDescriptionHtml();
  }
</code></pre>

<p>The web application, having already fetched an advertisement in the control tier, somewhere would have a view template looking something like</p>

<pre><code>    &lt;div&gt;
        &lt;h1&gt;&lt;c:out value="${advertisement.title}"/&gt;&lt;/h1&gt;
        &lt;p&gt;
            &lt;c:out value="${advertisement.description}" 
                      escapeXml="${!advertisement.descriptionHtml}"/&gt;
        &lt;/p&gt;
    &lt;/div&gt;
</code></pre>

<p><img src="/wp-content/uploads/2010/11/information.gif" alt="" /></p>

<p>Here we add another dimension: simple escaping with c:out won't work if you actually want to write html (and what is the safety and quality of such html data).</p>

<p>When this service is used by different applications each with their own view templates, and maybe also exposed through web services, you end up no doubt protecting it over many times, system developers in the web services, and front end developers in each of the presentation layers... likely there will be confusion over the safety and quality of data coming from this service, and of course everyone will be doing it differently so nothing will be consistent.</p>

<ul>
<li><p>Is there a better way?</p></li>
<li><p>Can we achieve a consistent XSS protection in such an environment?</p></li>
<li><p>How many developers need to know about XSS and about the origin of the data being served?</p></li>
</ul>


<p>In the above code if we can guarantee that the service <em>always</em> returns safe data then we can simplify it by removing the isDecriptionHtml() method. The same code and view template would become</p>

<pre><code>  interface AdvertisementService{
    Advertisement getAdvertisement(long id);
  }

  /** All fields xss protected */
  interface Advertisement{
    /** returns plain text title */
    String getTitle();
    /** return description, which may contain safe html */
    String getDescription();
  }






    &lt;div&gt;
        &lt;h1&gt;${advertisement.title}&lt;/h1&gt;
        &lt;p&gt;${advertisement.description}&lt;/p&gt;
    &lt;/div&gt;
</code></pre>

<p>By introducing one constraint: that <strong>all data is xss protected in the services tier</strong>; we have provided a simpler and more solid service API, and allowed all applications to have simpler, more concise, more readable, view templates.</p>

<h2>Solutions</h2>

<p><em>Having a clean database</em> all non-html data can be escaped as it comes in. Take advantage of Apache's StringEscapeUtils.escapeHtml(..) from <a href="http://commons.apache.org/lang/">commons-lang</a> library. For incoming html one can take advantage of a rich html manipulation tool, eg like JSoap, to clean, normalise, and standardise it.</p>

<p><em>With legacy or foreign data</em>, especially those applications with exposed service architecture and/or multiple front ends, a different approach is best: ensure nothing unsafe ever comes out of the services tier. For the html data the services will often be filtering many snippets of html over and over again, so this needs to be fast and a heavy html manipulation library like JSoap isn't appropriate any more.
A suitable library is <a href="http://finn-no.github.com/xss-html-filter">xss-html-filter</a>, a port from libfilter. It is fast and has an easy API</p>

<pre><code>String safeHtml = new HTMLInputFilter().filter( "some html" );
</code></pre>

<p>If we do this it means
<img src="/wp-content/uploads/2010/11/lightbulb_on.gif" alt="" /> xss protection is not duplicated, but rather made clear who is responsible for what,
<img src="/wp-content/uploads/2010/11/lightbulb_on.gif" alt="" /> c:out becomes just junk in verbosity and performance* ,
<img src="/wp-content/uploads/2010/11/lightbulb_on.gif" alt="" /> service APIs become simpler,
<img src="/wp-content/uploads/2010/11/lightbulb_on.gif" alt="" /> view templates look the same for both new and legacy applications,
<img src="/wp-content/uploads/2010/11/lightbulb_on.gif" alt="" /> system developers become responsible for protection of database data and this creates a natural incentive for them to clean up existing data and ensure new data comes in safe,</p>

<ul>
<li>No matter what an inescapable fact is all front ends developers must have a concrete understanding that any value fresh from the request is prone to <em>Reflected XSS</em> and there's nobody but them that can be responsible for protecting these values.</li>
</ul>


<p><strong>XSS protection has become a basic knowledge requirement for all developers</strong>.
<em>Like much to do about security ... it's always only as strong as its weakest link</em>.</p>

<p>At FINN.no because we take security seriously, and because we know we are only human and we need some room for the occasional mistake, for each release we run security audits. These include using <a href="http://www.watchcom.no/">WatchCom</a> reports, tools like <a href="http://www.acunetix.com/">Acunetix</a>, and custom tests using <a href="http://cukes.info/">Cucumber</a>.</p>

  </div>
  <p>2011-04-08 07:09:39 UTC by mick in interface developmentsystems development</p>
  <hr>



<div class="phl">
  
    <a href="/page4">&laquo; Prev</a>
  

  
    
      <a href="/index.html">1</a>
    
  
    
      <a href="/page2">2</a>
    
  
    
      <a href="/page3">3</a>
    
  
    
      <a href="/page4">4</a>
    
  
    
      <em>5</em>
    
  
    
      <a href="/page6">6</a>
    
  
    
      <a href="/page7">7</a>
    
  

  
    <a href="/page6">Next &raquo;</a>
  
</div>




        </div>
      </div>
    </div>
  </div>
  <div class="unit r-size1of3">
    <div class="mod shadow mbn">
      <div class="inner">
        <div class="bd">

          <h2>What’s this?</h2>
          <p>This is a blog run by the people creating the service <a href="http://www.finn.no">FINN.no</a>. Our purpose with this blog is to provide an insight into how we build things and to share our experiences with anyone who is interested in learning.
          </p>

          <h2>Categories</h2>
          <ul class="bullets phl">
            
              <li><a href="/categories/interface development.html">interface development</a></li>
            
              <li><a href="/categories/systems development.html">systems development</a></li>
            
              <li><a href="/categories/behind the scenes.html">behind the scenes</a></li>
            
              <li><a href="/categories/methodology.html">methodology</a></li>
            
          </ul>

          <h2>Blogroll</h2>
          <ul>
            <li><a href="http://labs.finn.no" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://labs.finn.no']);">FINN Labs</a></li>
            <li><a href="http://finn.no" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://finn.no']);">FINN.no</a></li>
            <li><a href="http://github.com/finn-no" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://github.com/finn-no']);">Our GitHub projects</a></li>
          </ul>
          <a class="phl" href="https://developer.mozilla.org/en/JavaScript" title="MDN JavaScript Home"><img src="http://static.jsconf.us/promotejsh.gif" height="150" width="180" alt="MDN JavaScript Home"></a>

        </div>
      </div>
    </div>
    <div class="mod nerddeco"></div>
  </div>
</div>
<div class="footer pal bg-contrast contrast">
  <a href="http://twitter.com/finn_tech">Finn Technology on Twitter</a> |
  <a href="http://tech.finn.no">Our developer blog</a> |
  <a href="http://hjemmehos.finn.no/no/jobbe_her+/">Come work with us!</a> |
  <a href="http://finn.no">FINN.no</a>
</div>
</div>
</body>
</html>